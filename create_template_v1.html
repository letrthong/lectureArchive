<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ứng Dụng Tạo Slide Bài Giảng (Có Nhập/Xuất Toàn Bộ JSON)</title>
    <!-- Tải Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Đặt font Inter cho giao diện */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f4f7f9;
        }
        /* Style cho modal - đảm bảo luôn nằm trên cùng */
        .modal {
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        .modal.hidden {
            opacity: 0;
            visibility: hidden;
        }
        /* Styling đặc biệt cho modal Xem Slide */
        #view-modal .slide-title {
            color: #1e40af; /* Blue-800 */
            border-bottom: 2px solid #93c5fd; /* Blue-300 */
        }
        #view-modal .slide-content li {
            font-size: 1.125rem; /* text-lg */
            margin-bottom: 0.5rem;
            list-style-type: disc;
            color: #374151; /* Gray-700 */
        }
        /* CUSTOM: Cho textarea tự động co giãn */
        textarea.auto-resize {
            /* Giữ nguyên resize: none */
            resize: none;
            overflow: hidden;
        }
    </style>
    
    <script type="module">
        // --- Cấu hình Local Storage ---
        const LOCAL_STORAGE_KEY = 'slide_decks_v4_template_change'; 

        let userId = 'local_user'; // Giả lập User ID cho mục đích hiển thị
        let currentEditId = null; 
        
        // Cấu trúc tempBlocks: [{ order: number, notes: string, imageBase64: string|null, content: [{ order: number, text: string }] }] 
        let tempBlocks = []; 
        
        // Base64 cho ảnh tham khảo CHUNG (chỉ 1 ảnh string hoặc null)
        let tempReferenceImageBase64 = null; 

        let allTasksData = []; 
        let currentBlockImageBase64 = null; // Base64 cho ảnh của slide đang chỉnh sửa

        // --- Tham Chiếu DOM ---
        const tasksList = document.getElementById('tasks-list');
        const modal = document.getElementById('task-modal'); 
        const viewModal = document.getElementById('view-modal'); 
        const viewTaskDetailsContainer = document.getElementById('view-task-details'); 
        
        const taskPageInput = document.getElementById('task-page-input'); 
        const taskTemplateInput = document.getElementById('task-template-input'); // ĐÃ CẬP NHẬT TÊN ID
        const taskTitleInput = document.getElementById('task-title-input'); 
        const taskDetailInput = document.getElementById('task-detail-input'); 
        const taskNotesInput = document.getElementById('task-notes-input'); // THÊM MỚI: NOTES INPUT

        // Image References DOM
        const imageUploadInput = document.getElementById('image-upload-input');
        const referenceImageContainer = document.getElementById('reference-images-container'); // Container cho 1 ảnh
        
        // Block/Slide DOM references
        const blockOrderInput = document.getElementById('block-order-input'); 
        const blockNotesInput = document.getElementById('block-notes-input'); 
        const newContentItemInput = document.getElementById('new-content-item-input'); 
        const addContentItemButton = document.getElementById('add-content-item-btn');
        const currentBlockContentList = document.getElementById('current-block-content-list');
        const addNewBlockButton = document.getElementById('add-new-block-btn');
        const blocksListContainer = document.getElementById('blocks-list-container');
        const blockImagePreviewContainer = document.getElementById('block-image-preview-container'); 

        const modalTitle = document.getElementById('modal-title');
        const saveButton = document.getElementById('save-task-btn');
        const messageBox = document.getElementById('message-box');
        const messageText = document.getElementById('message-text');

        // Lấy tham chiếu mới cho các nút tĩnh
        const addTaskBtn = document.getElementById('add-task-btn');
        const downloadAllBtn = document.getElementById('download-all-btn');
        const importAllBtn = document.getElementById('import-all-btn'); 
        const closeModalBtn = document.getElementById('close-modal-btn');
        const closeViewModalBtn = document.getElementById('close-view-modal-btn');
        
        const blockImageUploadInput = document.getElementById('block-image-upload-input'); 

        let currentBlockContent = []; 
        let isEditingBlock = -1; 
        
        /**
         * Chức năng tự động điều chỉnh chiều cao textarea.
         * Chỉ gọi khi có nội dung để tăng chiều cao
         */
        function autoResizeTextarea(element) {
            element.style.height = 'auto';
            element.style.height = (element.scrollHeight) + 'px';
        }

        // --- Chức Năng Hiển Thị Thông Báo (Thay thế alert/confirm) ---
        function showMessage(text, type = 'info') {
            messageText.textContent = text;
            messageBox.className = `p-3 mb-4 rounded-lg text-sm transition-opacity duration-300 ${type === 'error' ? 'bg-red-100 text-red-800' : 'bg-green-100 text-green-800'}`;
            messageBox.classList.remove('opacity-0', 'hidden');
            setTimeout(() => {
                messageBox.classList.add('opacity-0');
                setTimeout(() => messageBox.classList.add('hidden'), 300);
            }, 3000);
        }
        
        /**
         * Hàm confirm giả (vì không được dùng window.confirm) - Cần thay thế bằng modal UI thực tế
         */
        function confirmAction(message) {
            console.warn("Cảnh báo: Hàm xác nhận đang sử dụng logic tạm thời. Cần thay thế bằng modal UI.");
            return true; 
        }

        // --- QUẢN LÝ LOCAL STORAGE ---

        /**
         * Tải dữ liệu từ Local Storage.
         */
        function loadTasksFromLocal() {
            try {
                const data = localStorage.getItem(LOCAL_STORAGE_KEY);
                return data ? JSON.parse(data) : [];
            } catch (error) {
                console.error("Lỗi khi tải dữ liệu từ Local Storage:", error);
                return [];
            }
        }

        /**
         * Lưu dữ liệu vào Local Storage.
         */
        function saveTasksToLocal() {
            try {
                localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(allTasksData));
            } catch (error) {
                console.error("Lỗi khi lưu dữ liệu vào Local Storage:", error);
                showMessage('Lỗi khi lưu dữ liệu cục bộ.', 'error');
            }
        }
        
        // --- CHỨC NĂNG XÁC THỰC DỮ LIỆU JSON (MỚI) ---
        /**
         * Kiểm tra cấu trúc cơ bản của một Bộ Slide.
         * Cần có: title (string không rỗng) và blocks (array).
         */
        function isValidTaskStructure(data) {
            if (typeof data !== 'object' || data === null) {
                return false;
            }
            // Kiểm tra Tiêu đề
            if (typeof data.title !== 'string' || data.title.trim() === '') {
                return false;
            }
            // Kiểm tra Blocks (Slides)
            if (!Array.isArray(data.blocks)) {
                return false;
            }
            return true;
        }
        // --- END CHỨC NĂNG XÁC THỰC DỮ LIỆU JSON ---

        // --- QUẢN LÝ ẢNH CHUNG (Reference Image - Chỉ 1 ảnh) ---

        window.handleImageUpload = (event) => {
            const file = event.target.files[0];
            if (!file) return;
            event.target.value = ''; // Reset input để cho phép chọn lại cùng 1 file

            const MAX_SIZE = 5 * 1024 * 1024; // 5MB
            if (file.size > MAX_SIZE) {
                showMessage("Kích thước ảnh không được vượt quá 5MB.", 'error');
                return;
            }

            const reader = new FileReader();
            reader.onload = (e) => {
                tempReferenceImageBase64 = e.target.result; // Lưu string Base64 duy nhất
                window.renderReferenceImage();
                showMessage("Đã tải ảnh tham khảo chung thành công.");
            };
            reader.onerror = (e) => {
                console.error("Lỗi đọc tệp:", e);
                showMessage("Không thể đọc tệp ảnh.", 'error');
            };
            reader.readAsDataURL(file);
        };

        window.removeReferenceImage = () => {
            tempReferenceImageBase64 = null;
            window.renderReferenceImage();
            showMessage("Đã xóa ảnh tham khảo chung.");
        };

        window.renderReferenceImage = () => {
            referenceImageContainer.innerHTML = '';
            
            if (tempReferenceImageBase64) {
                referenceImageContainer.innerHTML = `
                    <div class="flex items-center justify-between p-2 bg-white rounded-lg shadow-sm border border-gray-100">
                        <div class="flex items-start space-x-3 flex-grow min-w-0">
                            <img src="${tempReferenceImageBase64}" alt="Reference Image" 
                                class="w-12 h-12 object-cover rounded-md border border-gray-200 flex-shrink-0">
                            <div class="min-w-0 pt-0.5">
                                <span class="block text-sm font-semibold text-gray-700 truncate">Ảnh Tham Khảo Chung</span>
                                <span class="text-xs text-gray-500">Kích thước Base64: ${(tempReferenceImageBase64.length / 1024).toFixed(1)} KB</span>
                            </div>
                        </div>
                        <button type="button" onclick="window.removeReferenceImage()" 
                                class="text-red-500 hover:text-red-700 text-lg leading-none p-1 rounded-full hover:bg-red-50 transition duration-150 flex-shrink-0">
                            &times;
                        </button>
                    </div>
                `;
            } else {
                referenceImageContainer.innerHTML = `<p class="text-center text-gray-400 text-sm py-2">Chưa có ảnh tham khảo chung nào được thêm.</p>`;
            }
        };

        // --- QUẢN LÝ ẢNH RIÊNG CHO SLIDE (Block Image) ---

        window.handleBlockImageUpload = (event) => {
            const file = event.target.files[0];
            if (!file) return;
            event.target.value = ''; 

            const MAX_SIZE = 5 * 1024 * 1024; // 5MB
            if (file.size > MAX_SIZE) {
                showMessage("Kích thước ảnh slide không được vượt quá 5MB.", 'error');
                return;
            }

            const reader = new FileReader();
            reader.onload = (e) => {
                currentBlockImageBase64 = e.target.result;
                window.renderCurrentBlockImage();
                showMessage("Đã tải ảnh slide thành công.");
            };
            reader.onerror = (e) => {
                console.error("Lỗi đọc tệp:", e);
                showMessage("Không thể đọc tệp ảnh cho Slide.", 'error');
            };
            reader.readAsDataURL(file);
        };

        window.removeCurrentBlockImage = () => {
            currentBlockImageBase64 = null;
            window.renderCurrentBlockImage();
            showMessage("Đã xóa ảnh slide.");
        };

        window.renderCurrentBlockImage = () => {
            blockImagePreviewContainer.innerHTML = '';
            if (currentBlockImageBase64) {
                blockImagePreviewContainer.innerHTML = `
                    <div class="p-2 bg-white rounded-lg shadow-inner border border-green-200 flex items-center justify-between">
                        <img src="${currentBlockImageBase64}" alt="Slide Reference" 
                            class="w-12 h-12 object-cover rounded-md border border-gray-200 flex-shrink-0">
                        <span class="text-sm font-medium text-green-700 ml-3 flex-grow truncate">Ảnh Slide Đã Tải Lên</span>
                        <button type="button" onclick="window.removeCurrentBlockImage()" 
                                class="text-red-500 hover:text-red-700 text-lg leading-none p-1 rounded-full hover:bg-red-50 transition duration-150 flex-shrink-0">
                            &times;
                        </button>
                    </div>
                `;
            } else {
                blockImagePreviewContainer.innerHTML = `<p class="text-center text-gray-400 text-sm py-2">Chưa có ảnh nào cho Slide này.</p>`;
            }
        };


        // --- Quản lý Nội dung (content) của Slide hiện tại (DÙNG ORDER) ---
        
        /**
         * Cập nhật lại thuộc tính order cho tất cả các mục trong currentBlockContent.
         */
        function reorderContentItems() {
            currentBlockContent.forEach((item, index) => {
                item.order = index + 1;
            });
        }

        window.renderCurrentBlockContent = () => {
            currentBlockContentList.innerHTML = '';
            if (currentBlockContent.length === 0) {
                currentBlockContentList.innerHTML = '<p class="text-center text-gray-400 text-sm py-2">Chưa có dòng nội dung nào được thêm.</p>';
                return;
            }

            // Đảm bảo array được sắp xếp theo index (là thứ tự hiện tại)
            reorderContentItems(); 
            
            currentBlockContent.forEach((itemObj, index) => {
                const textContent = itemObj.text || 'Nội dung lỗi';
                const orderNumber = itemObj.order || index + 1;
                
                const itemHtml = `
                    <div class="flex items-center justify-between bg-white p-2 rounded-lg shadow-sm border border-gray-100">
                        <div class="flex items-start flex-grow min-w-0">
                            <span class="text-xs font-semibold text-gray-400 mr-2 mt-0.5">${orderNumber}.</span>
                            <span class="text-gray-700 text-sm break-all whitespace-pre-wrap flex-grow min-w-0">${textContent}</span>
                        </div>
                        <div class="flex space-x-1 flex-shrink-0 ml-2">
                            <!-- Nút Lên -->
                            <button type="button" onclick="window.moveContentItem(${index}, 'up')" 
                                    ${index === 0 ? 'disabled' : ''} 
                                    class="p-1 text-xs text-blue-500 rounded-full hover:bg-blue-100 transition duration-150 disabled:opacity-30">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 10l7-7m0 0l7 7m-7-7v18"></path></svg>
                            </button>
                            <!-- Nút Xuống -->
                            <button type="button" onclick="window.moveContentItem(${index}, 'down')" 
                                    ${index === currentBlockContent.length - 1 ? 'disabled' : ''} 
                                    class="p-1 text-xs text-blue-500 rounded-full hover:bg-blue-100 transition duration-150 disabled:opacity-30">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 14l-7 7m0 0l-7-7m7 7V3"></path></svg>
                            </button>
                            <!-- Nút Xóa -->
                            <button type="button" onclick="window.removeCurrentContentItem(${index})" 
                                    class="text-red-500 hover:text-red-700 text-lg leading-none p-1 rounded-full hover:bg-red-50 transition duration-150">
                                &times;
                            </button>
                        </div>
                    </div>
                `;
                currentBlockContentList.insertAdjacentHTML('beforeend', itemHtml);
            });
        }

        window.addCurrentContentItem = () => {
            const newItemsText = newContentItemInput.value.trim();
            if (newItemsText.length > 0) {
                const items = newItemsText.split(/\r?\n/).map(item => item.trim()).filter(item => item.length > 0);
                
                if (items.length > 0) {
                    items.forEach(itemText => {
                        currentBlockContent.push({
                            order: currentBlockContent.length + 1, 
                            text: itemText
                        });
                    });
                    newContentItemInput.value = '';
                    autoResizeTextarea(newContentItemInput); 
                    reorderContentItems();
                    window.renderCurrentBlockContent();
                    newContentItemInput.focus();
                } else {
                     showMessage('Vui lòng nhập nội dung hợp lệ.', 'error');
                }
            } else {
                showMessage('Vui lòng nhập nội dung cho mục mới (mỗi dòng là 1 gạch đầu dòng).', 'error');
            }
        };

        window.removeCurrentContentItem = (index) => {
            currentBlockContent.splice(index, 1);
            reorderContentItems(); 
            window.renderCurrentBlockContent();
        };

        window.moveContentItem = (index, direction) => {
            if (direction === 'up' && index > 0) {
                [currentBlockContent[index], currentBlockContent[index - 1]] = [currentBlockContent[index - 1], currentBlockContent[index]];
            } else if (direction === 'down' && index < currentBlockContent.length - 1) {
                [currentBlockContent[index], currentBlockContent[index + 1]] = [currentBlockContent[index + 1], currentBlockContent[index]];
            } else {
                return;
            }
            reorderContentItems();
            window.renderCurrentBlockContent();
        };

        // --- Quản lý Slides (danh sách tempBlocks) ---

        window.renderBlocksListInModal = () => {
            blocksListContainer.innerHTML = '';
            
            tempBlocks.sort((a, b) => (a.order || 999) - (b.order || 999));

            if (tempBlocks.length === 0) {
                blocksListContainer.innerHTML = '<p class="text-center text-gray-400 text-sm py-2">Chưa có slide nào được thêm.</p>';
                return;
            }

            tempBlocks.forEach((block, index) => {
                const contentCount = block.content?.length || 0;
                const imageStatus = block.imageBase64 ? 'Ảnh: CÓ' : 'Ảnh: KHÔNG'; 
                const itemHtml = `
                    <div class="flex justify-between items-center bg-indigo-50 p-3 rounded-xl border border-indigo-100 shadow-sm">
                        <div class="flex-grow">
                            <span class="text-xs font-light text-indigo-500">Thứ tự: ${block.order || 'N/A'} | ${imageStatus}</span>
                            <span class="font-semibold text-indigo-800 truncate block">${index + 1}. ${block.notes}</span>
                            <span class="text-xs text-gray-500">${contentCount} gạch đầu dòng</span>
                        </div>
                        <div class="flex space-x-2 flex-shrink-0 ml-2">
                            <button type="button" onclick="window.editBlock(${index})" 
                                    class="text-blue-500 hover:text-blue-700 p-1 rounded-full hover:bg-blue-100 transition duration-150">
                                Sửa
                            </button>
                            <button type="button" onclick="window.removeBlock(${index})" 
                                    class="text-red-500 hover:text-red-700 p-1 rounded-full hover:bg-red-100 transition duration-150">
                                Xóa
                            </button>
                        </div>
                    </div>
                `;
                blocksListContainer.insertAdjacentHTML('beforeend', itemHtml);
            });
        }

        window.addNewBlock = () => {
            const blockNotes = blockNotesInput.value.trim();
            const blockOrder = parseInt(blockOrderInput.value.trim());

            if (blockNotes === '') {
                return showMessage('Vui lòng nhập Tiêu đề Slide.', 'error');
            }
            if (isNaN(blockOrder) || blockOrder < 1) {
                return showMessage('Thứ tự (Order) phải là một số nguyên dương.', 'error');
            }

            reorderContentItems(); 
            
            const newBlock = {
                order: blockOrder, 
                notes: blockNotes,
                imageBase64: currentBlockImageBase64, 
                content: [...currentBlockContent] 
            };
            
            if (isEditingBlock !== -1) {
                tempBlocks[isEditingBlock] = newBlock;
            } else {
                tempBlocks.push(newBlock);
            }
            
            tempBlocks.sort((a, b) => (a.order || 999) - (b.order || 999));

            window.resetBlockForm();
            window.renderBlocksListInModal();
        };

        window.editBlock = (index) => {
            isEditingBlock = index;
            const blockToEdit = tempBlocks[index];

            blockOrderInput.value = blockToEdit.order || tempBlocks.length + 1; 
            blockNotesInput.value = blockToEdit.notes;
            currentBlockImageBase64 = blockToEdit.imageBase64 || null; 
            
            currentBlockContent = Array.isArray(blockToEdit.content) ? JSON.parse(JSON.stringify(blockToEdit.content)) : []; 
            
            newContentItemInput.value = '';
            // Reset height to auto to ensure it shows rows=6 or larger content if applicable
            newContentItemInput.style.height = 'auto'; 

            window.renderCurrentBlockContent();
            window.renderCurrentBlockImage(); 
            // Cập nhật text khi chuyển sang chế độ chỉnh sửa
            addNewBlockButton.textContent = 'Lưu Nội Dung'; 
            blockOrderInput.focus(); 
        };

        window.removeBlock = (index) => {
            if (isEditingBlock === index) window.resetBlockForm(); 
            tempBlocks.splice(index, 1);
            
            window.resetBlockForm();
            window.renderBlocksListInModal();
        };

        window.resetBlockForm = () => {
            tempBlocks.sort((a, b) => (a.order || 999) - (b.order || 999));
            const nextOrder = tempBlocks.length + 1;
            
            blockOrderInput.value = nextOrder;

            blockNotesInput.value = '';
            newContentItemInput.value = '';
            
            // Đảm bảo chiều cao trở về mặc định (rows="6") khi reset nội dung
            newContentItemInput.style.height = 'auto'; 

            currentBlockContent = [];
            currentBlockImageBase64 = null; 
            isEditingBlock = -1;
            window.renderCurrentBlockContent();
            window.renderCurrentBlockImage(); 
            // Cập nhật text theo yêu cầu mới
            addNewBlockButton.textContent = 'Thêm mới nội dung mới'; 
        }

        // --- Chức Năng Modal/Popup Tạo/Sửa Slide Deck ---

        /**
         * Mở modal tạo/sửa Bộ Slide.
         * ĐÃ CẬP NHẬT: Thêm tham số taskNotes
         */
        window.openModal = (mode = 'add', taskId = null, taskPage = 1, taskTemplate = '1', taskTitle = '', taskDetail = '', taskNotes = '', blocks = [], referenceImageBase64 = null) => { 
            currentEditId = taskId;
            taskTitleInput.value = taskTitle;
            taskPageInput.value = taskPage || 1; 
            taskTemplateInput.value = taskTemplate || '1'; // ĐÃ CẬP NHẬT TÊN BIẾN
            taskDetailInput.value = taskDetail || ''; 
            taskNotesInput.value = taskNotes || ''; // THÊM MỚI: NOTES INPUT

            tempBlocks = Array.isArray(blocks) ? JSON.parse(JSON.stringify(blocks)) : []; 
            tempReferenceImageBase64 = referenceImageBase64 || null; // Load the single string
            currentBlockImageBase64 = null; 

            window.renderBlocksListInModal(); 
            window.resetBlockForm(); 
            window.renderReferenceImage(); // RENDER SINGLE REFERENCE IMAGE

            if (mode === 'add') {
                modalTitle.textContent = 'Tạo một Bộ Slide mới';
                saveButton.textContent = 'Tạo Slide'; 
            } else { // mode === 'edit'
                modalTitle.textContent = 'Sửa Bộ Slide';
                saveButton.textContent = 'Lưu Slide'; 
            }
            modal.classList.remove('hidden');
            taskPageInput.focus(); 
        };

        window.closeModal = () => {
            modal.classList.add('hidden');
            taskTitleInput.value = '';
            taskPageInput.value = '1'; 
            taskTemplateInput.value = '1'; // ĐÃ CẬP NHẬT TÊN BIẾN
            taskDetailInput.value = ''; 
            taskNotesInput.value = ''; // THÊM MỚI: RESET NOTES INPUT
            tempBlocks = []; 
            tempReferenceImageBase64 = null; // Reset
            currentBlockImageBase64 = null; 
            window.resetBlockForm();
            currentEditId = null;
        };
        
        modal.addEventListener('click', (e) => {
            if (e.target === modal) {
                window.closeModal();
            }
        });
        
        // --- Chức Năng Modal/Popup Xem Slide ---
        window.openViewModal = () => {
            viewModal.classList.remove('hidden');
        };

        window.closeViewModal = () => {
            viewModal.classList.add('hidden');
            viewTaskDetailsContainer.innerHTML = ''; 
        };

        viewModal.addEventListener('click', (e) => {
            if (e.target === viewModal) {
                window.closeViewModal();
            }
        });

        /**
         * Hàm chuẩn hóa dữ liệu JSON để đảm bảo cấu trúc Block và Content
         * ĐÃ CẬP NHẬT: Thêm trường 'notes'
         */
        function normalizeTaskData(data) {
            data.id = data.id || crypto.randomUUID(); 
            
            if ('referenceImages' in data) delete data.referenceImages;
            if ('goal' in data) delete data.goal;
            if ('references' in data) delete data.references;

            if ('type' in data) {
                data.template = data.type; 
                delete data.type;
            }

            data.page = data.page || 1;
            data.template = data.template || '1'; 
            data.detail = data.detail || '';
            data.notes = data.notes || ''; // THÊM MỚI: NOTES FIELD
            data.referenceImagesBase64 = data.referenceImagesBase64 || null;
            data.createdAt = data.createdAt || Date.now();
            data.updatedAt = data.updatedAt || Date.now();

            if (Array.isArray(data.blocks)) {
                data.blocks = data.blocks.map(block => {
                    if (Array.isArray(block.content) && block.content.length > 0) {
                         if (typeof block.content[0] === 'string') {
                            block.content = block.content.map((text, index) => ({
                                order: index + 1,
                                text: text
                            }));
                        } else if (typeof block.content[0] === 'object' && block.content[0] !== null) {
                            block.content = block.content.sort((a, b) => (a.order || 999) - (b.order || 999));
                            block.content.forEach((item, index) => item.order = index + 1);
                        }
                    } else {
                        block.content = [];
                    }
                    block.imageBase64 = block.imageBase64 || null;
                    return block;
                });
                data.blocks.sort((a, b) => (a.order || 999) - (b.order || 999));
            } else {
                data.blocks = [];
            }
            
            return data;
        }

        // --- Chức Năng Nhập/Sửa Bộ Slide Bằng JSON (CÁ NHÂN) ---

        /**
         * Xử lý tệp JSON để nạp vào form chỉnh sửa.
         */
        function processJsonImport(taskId, file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                let importedData;
                try {
                    importedData = JSON.parse(e.target.result);
                } catch (error) {
                    return showMessage("Lỗi phân tích cú pháp JSON: Tệp tải lên không phải là JSON hợp lệ.", 'error');
                }
                
                try {
                    // ** BƯỚC XÁC THỰC 1: Cấu trúc cơ bản **
                    if (!isValidTaskStructure(importedData)) {
                        throw new Error("Cấu trúc JSON không hợp lệ. Tệp nhập phải là đối tượng Bộ Slide (thiếu 'title' hoặc 'blocks' là mảng).");
                    }
                    
                    const normalizedData = normalizeTaskData(importedData);
                    
                    const existingTask = allTasksData.find(t => t.id === taskId);
                    if (!existingTask) {
                        throw new Error("Không tìm thấy Bộ Slide hiện tại để cập nhật.");
                    }
                    
                    const updatedTask = {
                        ...existingTask,
                        ...normalizedData,
                        id: taskId,
                        createdAt: existingTask.createdAt,
                        updatedAt: Date.now(),
                    };
                    
                    const index = allTasksData.findIndex(t => t.id === taskId);
                    if (index !== -1) {
                        allTasksData[index] = updatedTask;
                        saveTasksToLocal();
                        renderTasks(allTasksData);
                        showMessage(`Đã nhập JSON thành công và cập nhật Bộ Slide: ${updatedTask.title}`);
                    } else {
                        throw new Error("Lỗi nội bộ khi tìm kiếm Bộ Slide để cập nhật.");
                    }

                } catch (error) {
                    console.error("Lỗi khi xử lý tệp JSON cá nhân:", error);
                    showMessage(`Lỗi nhập JSON cá nhân: ${error.message}`, 'error');
                }
            };
            reader.onerror = (e) => {
                showMessage("Không thể đọc tệp JSON.", 'error');
            };
            reader.readAsText(file);
        }

        /**
         * Mở hộp thoại chọn file cho việc nhập JSON để chỉnh sửa.
         */
        window.promptJsonImport = (taskId) => {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'application/json';
            input.style.display = 'none';

            input.onchange = (e) => {
                const file = e.target.files[0];
                if (file) {
                    processJsonImport(taskId, file);
                }
            };

            document.body.appendChild(input);
            input.click();
            document.body.removeChild(input);
        };
        
        // --- Chức Năng Nhập Toàn Bộ JSON (ARRAY) (MỚI) ---

        /**
         * Xử lý tệp JSON chứa một mảng các Bộ Slide để thêm vào danh sách.
         */
        function processAllJsonImport(file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                let importedData;
                try {
                    importedData = JSON.parse(e.target.result);
                } catch (error) {
                    return showMessage("Lỗi phân tích cú pháp JSON: Tệp tải lên không phải là JSON hợp lệ.", 'error');
                }
                
                try {
                    // ** BƯỚC XÁC THỰC 2: Phải là một mảng **
                    if (!Array.isArray(importedData)) {
                        throw new Error("Cấu trúc JSON không hợp lệ. Tệp nhập phải là một MẢNG chứa các đối tượng Bộ Slide.");
                    }
                    
                    let importedCount = 0;
                    let invalidCount = 0;
                    const now = Date.now();

                    importedData.forEach((dataItem, index) => {
                        // ** BƯỚC XÁC THỰC 3: Kiểm tra từng mục trong mảng **
                        if (isValidTaskStructure(dataItem)) {
                            // Chuẩn hóa dữ liệu và gán ID mới, thời gian mới
                            const newId = crypto.randomUUID();
                            const normalizedTask = normalizeTaskData(dataItem);
                            
                            // Gán ID mới và thời gian cập nhật/tạo mới
                            normalizedTask.id = newId; 
                            normalizedTask.createdAt = now;
                            normalizedTask.updatedAt = now;

                            allTasksData.push(normalizedTask);
                            importedCount++;
                        } else {
                            invalidCount++;
                            console.warn(`Bỏ qua mục nhập không hợp lệ tại index ${index}.`);
                        }
                    });

                    if (importedCount > 0) {
                        saveTasksToLocal();
                        renderTasks(allTasksData);
                        showMessage(`Đã nhập thành công ${importedCount} Bộ Slide mới! (${invalidCount} mục không hợp lệ đã bị bỏ qua).`);
                    } else if (invalidCount > 0) {
                        showMessage('Tất cả các mục trong tệp JSON đều không hợp lệ và đã bị bỏ qua.', 'error');
                    } else {
                        showMessage('Tệp JSON rỗng hoặc không có Bộ Slide hợp lệ nào được tìm thấy.', 'error');
                    }

                } catch (error) {
                    console.error("Lỗi khi xử lý tệp JSON toàn bộ:", error);
                    showMessage(`Lỗi nhập Toàn Bộ JSON: ${error.message}`, 'error');
                }
            };
            reader.onerror = (e) => {
                showMessage("Không thể đọc tệp JSON.", 'error');
            };
            reader.readAsText(file);
        }

        /**
         * Mở hộp thoại chọn file cho việc nhập Toàn Bộ JSON.
         */
        window.promptAllJsonImport = () => {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'application/json';
            input.style.display = 'none';

            input.onchange = (e) => {
                const file = e.target.files[0];
                if (file) {
                    processAllJsonImport(file);
                }
            };

            document.body.appendChild(input);
            input.click();
            document.body.removeChild(input);
        };


        // --- Xử Lý CRUD Local Storage ---

        /**
         * Thêm hoặc Cập nhật Bộ Slide
         * ĐÃ CẬP NHẬT: Thêm trường 'notes'
         */
        function handleSaveTask() {
            const title = taskTitleInput.value.trim();
            const detail = taskDetailInput.value.trim();
            const notes = taskNotesInput.value.trim(); // THÊM MỚI: NOTES VALUE
            const pageValue = taskPageInput.value.trim();
            const page = parseInt(pageValue) || 1;
            const template = taskTemplateInput.value.trim(); // ĐÃ CẬP NHẬT TÊN BIẾN

            if (title === '') {
                return showMessage('Vui lòng nhập Tiêu đề cho Bộ Slide.', 'error');
            }
            
            if (pageValue === '' || page < 1 || isNaN(page)) {
                return showMessage('Số Trang (Page) phải là một số nguyên dương.', 'error');
            }

            if (isEditingBlock !== -1) {
                 // Cập nhật thông báo lỗi để nhất quán với tên nút mới
                 return showMessage('Vui lòng nhấn "Lưu Nội Dung" hoặc "Hủy Chỉnh Sửa Nội Dung" trước khi Lưu Bộ Slide.', 'error');
            }
            
            const now = Date.now();
            
            const taskData = {
                id: currentEditId || crypto.randomUUID(), 
                page: page, 
                template: template, // ĐÃ CẬP NHẬT TÊN TRƯỜNG JSON
                title: title, 
                detail: detail, 
                notes: notes, // THÊM MỚI: NOTES FIELD
                referenceImagesBase64: tempReferenceImageBase64, 
                blocks: tempBlocks, 
                updatedAt: now,
                createdAt: currentEditId ? allTasksData.find(t => t.id === currentEditId).createdAt : now,
            };

            if (currentEditId) {
                const index = allTasksData.findIndex(t => t.id === currentEditId);
                if (index !== -1) {
                    allTasksData[index] = taskData;
                    showMessage('Đã cập nhật Bộ Slide thành công!');
                }
            } else {
                allTasksData.push(taskData);
                showMessage('Đã tạo Bộ Slide mới thành công!');
            }
            
            saveTasksToLocal();
            renderTasks(allTasksData);

            window.closeModal();
        }

        /**
         * Xóa bộ slide
         */
        window.deleteTask = (taskId) => {
            if (!confirmAction("Bạn có chắc chắn muốn xóa Bộ Slide này không?")) {
                return;
            }

            const initialLength = allTasksData.length;
            allTasksData = allTasksData.filter(task => task.id !== taskId);
            
            if (allTasksData.length < initialLength) {
                saveTasksToLocal();
                renderTasks(allTasksData);
                showMessage('Đã xóa Bộ Slide thành công!');
            } else {
                 showMessage('Lỗi khi xóa: Không tìm thấy Bộ Slide.', 'error');
            }
        };

        
        /**
         * Hiển thị nội dung chi tiết (View) trong modal theo dạng Slide
         * ĐÃ CẬP NHẬT: Hiển thị Ghi chú (Notes)
         */
        window.viewTask = (taskId) => {
             const data = allTasksData.find(task => task.id === taskId);
             
             if (!data) {
                viewTaskDetailsContainer.innerHTML = '<p class="text-center text-red-500 py-4">Lỗi: Không tìm thấy Bộ Slide này.</p>';
                window.openViewModal();
                return;
             }

            window.openViewModal();

            let htmlContent = '';
            
            const sortedBlocks = (data.blocks || []).slice().sort((a, b) => (a.order || 999) - (b.order || 999));
            const referenceImageBase64 = data.referenceImagesBase64; // Lấy single string
            
            const template = data.template || 'N/A'; 

            // 1. Tiêu đề Bộ Slide/Bài Giảng và Detail
            htmlContent += `
                <div class="bg-indigo-600 p-6 rounded-t-xl shadow-md text-white text-center mb-6">
                    <p class="text-sm font-light opacity-80 mb-1">Trang ${data.page || 'N/A'} | Mẫu (Template): ${template}</p>
                    <h3 class="text-3xl font-extrabold break-words">${data.title || 'Bài Giảng Không Tên'}</h3>
                    <p class="text-sm font-light opacity-90 mt-2 whitespace-pre-wrap">${data.detail || 'Không có giải thích chi tiết.'}</p>
                    
                    <!-- THÊM MỚI: HIỂN THỊ GHI CHÚ (NOTES) -->
                    ${data.notes ? `<div class="mt-3 p-3 bg-indigo-700/50 rounded-lg">
                                <p class="text-sm font-medium text-white/90">Ghi chú (Presenter Notes):</p>
                                <p class="text-xs text-white/80 whitespace-pre-wrap">${data.notes}</p>
                            </div>` : ''}
                    <!-- KẾT THÚC THÊM MỚI -->

                </div>
                
                <!-- HIỂN THỊ CÁC TRƯỜNG THÔNG TIN KHÁC (REFERENCES & IMAGES) -->
                <div class="px-6 py-4 bg-indigo-50 rounded-xl mx-2 mb-6 shadow-inner text-indigo-900 border border-indigo-200">
                     
                     <!-- HIỂN THỊ ẢNH THAM KHẢO CHUNG (Bây giờ là 1e) -->
                     <p class="text-sm font-bold mt-0 mb-2 border-b border-indigo-300 pb-1">1e. Ảnh Tham Khảo Chung:</p>
                     <div class="grid grid-cols-1 gap-3 mt-3">
                         ${referenceImageBase64 ? `
                            <img src="${referenceImageBase64}" alt="Ảnh Tham Khảo Chung" 
                                class="w-full h-auto object-cover rounded-lg shadow-md border border-gray-300">
                         ` : '<p class="text-xs italic text-gray-500 col-span-1">Không có ảnh tham khảo chung.</p>'}
                     </div>
                     <!-- KẾT THÚC HIỂN THỊ ẢNH THAM KHẢO CHUNG -->

                </div>
                <!-- KẾT THÚC HIỂN THỊ CÁC TRƯỜNG KHÁC -->

                <div class="px-2">
            `;
            
            // 2. Các Slides (Blocks)
            if (sortedBlocks.length > 0) {
                sortedBlocks.forEach((block, index) => {
                    const contentList = block.content && Array.isArray(block.content) 
                        ? block.content.slice().sort((a, b) => (a.order || 999) - (b.order || 999))
                        : [];

                    const blockImageHtml = block.imageBase64 ? `
                        <div class="mt-4 mb-4">
                            <img src="${block.imageBase64}" alt="${block.notes} Image" 
                                class="w-full max-h-96 object-contain rounded-lg shadow-md border border-gray-300">
                            <p class="text-xs text-gray-400 italic text-center mt-1">Ảnh tham chiếu trong Slide</p>
                        </div>
                    ` : '';


                    const contentHtml = contentList.length > 0
                        ? contentList.map(itemObj => {
                            const textContent = itemObj.text || 'Nội dung trống';
                            return `<li class="whitespace-pre-wrap">${textContent}</li>`;
                        }).join('')
                        : '<li><p class="text-gray-400 text-sm italic list-none ml-[-20px]">Không có nội dung chi tiết.</p></li>';

                    htmlContent += `
                        <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-100 mb-6">
                            <p class="text-xs font-semibold text-gray-400 mb-1">SLIDE ${block.order || index + 1} / ${sortedBlocks.length}</p>
                            <h4 class="slide-title font-bold text-2xl pb-2 mb-3 break-words">${block.notes || 'Slide Không Tiêu Đề'}</h4>
                            
                            ${blockImageHtml} 

                            <ul class="slide-content space-y-2 ml-5">
                                ${contentHtml}
                            </ul>
                        </div>
                    `;
                });
                htmlContent += '</div>';
            } else {
                htmlContent += '<p class="text-gray-500 italic text-center mt-4">Bộ Slide này chưa có Slide nào.</p>';
            }

            // 3. Metadata
            const createdAtDate = data.createdAt ? new Date(data.createdAt).toLocaleString() : 'N/A';
            const updatedAtDate = data.updatedAt ? new Date(data.updatedAt).toLocaleString() : 'N/A';
            htmlContent += `
                <div class="mt-6 px-2 pt-4 border-t border-gray-200 text-xs text-gray-500 space-y-1">
                    <p><strong>Ngày tạo:</strong> ${createdAtDate}</p>
                    <p><strong>Cập nhật cuối:</strong> ${updatedAtDate}</p>
                </div>
            `;
            
            viewTaskDetailsContainer.innerHTML = htmlContent;
        };

        /**
         * Tải dữ liệu Bộ Slide cá nhân về dưới dạng JSON
         * ĐÃ CẬP NHẬT: Thêm trường 'notes'
         */
        window.downloadTaskJson = (taskId) => {
            const data = allTasksData.find(task => task.id === taskId);

            if (!data) {
                return showMessage('Không tìm thấy Bộ Slide để tải xuống.', 'error');
            }
            
            const exportData = {
                id: data.id,
                page: data.page || 1, 
                template: data.template || '1', 
                title: data.title,
                detail: data.detail || '',
                notes: data.notes || '', // THÊM MỚI: NOTES FIELD
                referenceImagesBase64: data.referenceImagesBase64 || null, 
                // Sắp xếp blocks, và mỗi block content cũng được đảm bảo có order
                blocks: (data.blocks || []).slice().sort((a, b) => (a.order || 999) - (b.order || 999)).map(block => ({
                    order: block.order,
                    notes: block.notes,
                    imageBase64: block.imageBase64 || null, 
                    content: (block.content || []).slice().sort((a, b) => (a.order || 999) - (b.order || 999))
                })),
            };

            const filename = `${(data.title || 'slide_deck').toLowerCase().replace(/\s/g, '_')}_${data.id.substring(0, 5)}.json`;
            
            const jsonString = JSON.stringify(exportData, null, 2);
            
            const blob = new Blob([jsonString], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            showMessage(`Đã tải xuống file: ${filename}`);
        }
        
        /**
         * Tải toàn bộ dữ liệu Bộ Slide về dưới dạng JSON (Array)
         * ĐÃ CẬP NHẬT: Thêm trường 'notes'
         */
        window.downloadAllTasksJson = () => {
            if (allTasksData.length === 0) {
                return showMessage('Không có Bộ Slide nào để tải xuống.', 'info');
            }

            try {
                const exportData = allTasksData.map(task => ({
                    id: task.id,
                    page: task.page,
                    template: task.template, 
                    title: task.title,
                    detail: task.detail,
                    notes: task.notes || '', // THÊM MỚI: NOTES FIELD
                    referenceImagesBase64: task.referenceImagesBase64 || null,
                    // Sắp xếp blocks và nội dung bên trong
                    blocks: (task.blocks || []).slice().sort((a, b) => (a.order || 999) - (b.order || 999)).map(block => ({
                        order: block.order,
                        notes: block.notes,
                        imageBase64: block.imageBase64 || null, 
                        content: (block.content || []).slice().sort((a, b) => (a.order || 999) - (b.order || 999))
                    })),
                }));
                
                const filename = `all_slide_decks_export_${new Date().toISOString().substring(0, 10)}.json`;
                const jsonString = JSON.stringify(exportData, null, 2);
                
                const blob = new Blob([jsonString], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);

                showMessage(`Đã tải xuống toàn bộ dữ liệu vào file: ${filename}`);

            } catch (error) {
                console.error("Lỗi khi tải xuống toàn bộ JSON:", error);
                showMessage('Lỗi khi tải xuống toàn bộ dữ liệu. Vui lòng thử lại.', 'error');
            }
        };


        /**
         * Render danh sách Bộ Slide
         * ĐÃ CẬP NHẬT: Truyền trường 'notes' khi gọi openModal
         */
        function renderTasks(tasks) {
            tasksList.innerHTML = ''; 
            
            tasks.sort((a, b) => (b.updatedAt || 0) - (a.updatedAt || 0));

            if (tasks.length === 0) {
                tasksList.innerHTML = `<p class="text-center text-gray-500 py-6">Chưa có Bộ Slide nào. Hãy tạo bài giảng đầu tiên của bạn!</p>`;
                return;
            }

            tasks.forEach(task => {
                const sortedBlocks = (task.blocks || []).slice().sort((a, b) => (a.order || 999) - (b.order || 999));
                const hasReferenceImage = task.referenceImagesBase64 ? 'CÓ' : 'KHÔNG'; // Check single image status
                
                const blocksSummary = sortedBlocks.length > 0
                    ? sortedBlocks.map((block) => {
                        const contentCount = block.content?.length || 0;
                        const hasImage = block.imageBase64 ? ' (Ảnh CÓ)' : '';
                        return `
                            <div class="mt-1 px-3 py-2 bg-gray-50 rounded-lg border border-gray-200">
                                <span class="text-xs font-light text-indigo-500">#${block.order || 'N/A'}${hasImage}</span>
                                <span class="block text-sm font-bold text-gray-700 truncate">${block.notes || 'Slide Không Tiêu Đề'}</span>
                                <span class="text-xs text-gray-500">${contentCount} gạch đầu dòng</span>
                            </div>
                        `;
                    }).join('')
                    : '<p class="text-xs text-gray-400">Chưa có Slide nào.</p>';


                // Chuẩn bị dữ liệu 'blocks' dưới dạng JSON string (không thay đổi)
                const blocksJson = task.blocks 
                    ? JSON.stringify(task.blocks)
                        .replace(/'/g, "\\'")     
                        .replace(/"/g, '&quot;')   
                    : '[]';
                
                // NEW: Prepare single reference image base64 string
                const sanitizedRefImageBase64 = task.referenceImagesBase64 
                    ? task.referenceImagesBase64.replace(/'/g, "\\'").replace(/"/g, '&quot;') 
                    : 'null'; 
                
                const sanitizedTitle = (task.title || '').replace(/'/g, "\\'").replace(/"/g, '&quot;');
                const sanitizedDetail = (task.detail || '').replace(/'/g, "\\'").replace(/"/g, '&quot;');
                const sanitizedNotes = (task.notes || '').replace(/'/g, "\\'").replace(/"/g, '&quot;'); // THÊM MỚI: NOTES
                const taskPage = task.page || 1; 
                const taskTemplate = task.template || '1'; 

                const itemHtml = `
                    <div class="bg-white p-4 rounded-xl shadow flex flex-col justify-between space-y-3">
                        <!-- Main Title (title) -->
                        <div class="pb-2 border-b">
                            <!-- Hiển thị Page và Template -->
                            <div class="flex justify-between items-center mb-1">
                                <span class="text-xs font-semibold text-indigo-500">Trang: ${taskPage}</span>
                                <span class="text-xs font-semibold text-purple-500">Mẫu (Template): ${taskTemplate}</span>
                            </div>
                            <span class="text-xl font-bold text-indigo-700 break-all">${task.title || 'Bộ Slide Không Tên'}</span>
                            <span class="block text-xs text-gray-500 mt-1">${sortedBlocks.length || 0} Slide | Ảnh Ref Chung: ${hasReferenceImage}</span>
                            <!-- Hiển thị tóm tắt Detail -->
                            <p class="text-xs italic text-gray-400 mt-1 truncate max-w-full">${task.detail || 'Không có giải thích.'}</p>
                            <!-- Hiển thị tóm tắt Notes -->
                            <p class="text-xs italic text-green-500 mt-1 truncate max-w-full">Ghi chú: ${task.notes || 'Không có ghi chú.'}</p>
                        </div>

                        <!-- Slides Summary -->
                        <div class="space-y-2 max-h-40 overflow-y-auto p-1">
                            ${blocksSummary}
                        </div>

                        <!-- Actions -->
                        <div class="flex space-x-2 flex-shrink-0 justify-end border-t pt-3 mt-3">
                            <!-- Nút Nhập JSON để Sửa (CÁ NHÂN) -->
                            <button onclick="window.promptJsonImport('${task.id}')" 
                                    title="Nhập JSON để Ghi đè/Sửa toàn bộ nội dung"
                                    class="p-2 text-xs font-semibold text-white bg-green-500 rounded-lg hover:bg-green-600 transition duration-150">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 13l3 3m0 0l3-3m-3 3V8m0 16c5.523 0 10-4.477 10-10S17.523 4 12 4 2 8.477 2 14s4.477 10 10 10z"></path>
                                </svg>
                            </button>
                            <!-- Nút Tải xuống JSON cá nhân -->
                            <button onclick="window.downloadTaskJson('${task.id}')" 
                                    title="Tải xuống JSON cá nhân"
                                    class="p-2 text-xs font-semibold text-gray-500 bg-gray-100 rounded-lg hover:bg-gray-200 transition duration-150">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
                                </svg>
                            </button>
                            <!-- Nút Xem -->
                            <button onclick="window.viewTask('${task.id}')" class="px-3 py-1 text-xs font-semibold text-white bg-blue-500 rounded-lg hover:bg-blue-600 transition duration-150">
                                Xem Slide
                            </button>
                            <!-- Nút Sửa: Truyền 'sanitizedNotes' (THÊM MỚI) -->
                            <button onclick="window.openModal('edit', '${task.id}', ${taskPage}, '${taskTemplate}', '${sanitizedTitle}', '${sanitizedDetail}', '${sanitizedNotes}', JSON.parse('${blocksJson}'), '${sanitizedRefImageBase64}')" class="px-3 py-1 text-xs font-semibold text-white bg-yellow-500 rounded-lg hover:bg-yellow-600 transition duration-150">
                                Sửa
                            </button>
                            <!-- Nút Xóa -->
                            <button onclick="window.deleteTask('${task.id}')" class="px-3 py-1 text-xs font-semibold text-white bg-red-500 rounded-lg hover:bg-red-600 transition duration-150">
                                Xóa
                            </button>
                        </div>
                    </div>
                `;
                tasksList.insertAdjacentHTML('beforeend', itemHtml);
            });
        }

        // --- Khởi tạo Ứng dụng Local ---
        function initLocalApp() {
            allTasksData = loadTasksFromLocal();
            
            // Xử lý chuyển đổi và làm sạch dữ liệu cũ (Đảm bảo tính tương thích)
            allTasksData.forEach(task => {
                // Xử lý chuyển đổi trường 'type' -> 'template'
                if ('type' in task) {
                    task.template = task.type; 
                    delete task.type;
                } else if (!('template' in task)) {
                    task.template = '1';
                }

                // Xử lý chuyển đổi referenceImages (Array) sang referenceImagesBase64 (String)
                if ('referenceImages' in task && Array.isArray(task.referenceImages)) {
                    task.referenceImagesBase64 = task.referenceImages.length > 0 ? task.referenceImages[0].base64 : null;
                    delete task.referenceImages; // Xóa trường cũ
                } else if (!('referenceImagesBase64' in task)) {
                    task.referenceImagesBase64 = null;
                }
                
                // Xóa trường goal cũ nếu nó tồn tại
                if ('goal' in task) {
                    delete task.goal;
                }
                
                // Xóa trường references (text) cũ nếu nó tồn tại
                if ('references' in task) {
                    delete task.references;
                }

                // THÊM MỚI: Đảm bảo trường 'notes' tồn tại
                if (!('notes' in task)) {
                    task.notes = '';
                }

                task.blocks?.forEach(block => {
                    // Cập nhật cấu trúc content (chuyển từ string[] sang object[])
                    if (block.content && block.content.length > 0 && typeof block.content[0] === 'string') {
                        block.content = block.content.map((text, index) => ({
                            order: index + 1,
                            text: text
                        }));
                    }
                    // Đảm bảo imageBase64 tồn tại (dùng null nếu không có)
                    if (!('imageBase64' in block)) {
                        block.imageBase64 = null;
                    }
                });
            });
            
            // Lưu lại để đảm bảo dữ liệu Local Storage được cập nhật key mới
            saveTasksToLocal(); 

            renderTasks(allTasksData);
            document.getElementById('user-id-display').textContent = `ID Người dùng: ${userId} (Local)`;
        }


        // Khởi tạo ứng dụng khi cửa sổ tải xong
        window.onload = () => {
            initLocalApp();
            
            // --- GẮN EVENT LISTENER CHO CÁC NÚT TĨNH ---
            addTaskBtn.addEventListener('click', () => window.openModal('add'));
            downloadAllBtn.addEventListener('click', window.downloadAllTasksJson);
            importAllBtn.addEventListener('click', window.promptAllJsonImport); 
            
            // Gán sự kiện cho các nút trong Modal
            saveButton.addEventListener('click', handleSaveTask);
            addNewBlockButton.addEventListener('click', window.addNewBlock);
            addContentItemButton.addEventListener('click', window.addCurrentContentItem);
            closeModalBtn.addEventListener('click', window.closeModal);
            closeViewModalBtn.addEventListener('click', window.closeViewModal);
            
            // Events cho Ảnh Chung
            imageUploadInput.addEventListener('change', window.handleImageUpload); 
            
            // Events cho Ảnh Slide (Mới)
            blockImageUploadInput.addEventListener('change', window.handleBlockImageUpload);

            // Tự động co giãn textarea. Chỉ gọi khi có input để tăng chiều cao
            newContentItemInput.addEventListener('input', () => {
                if (newContentItemInput.value.trim() !== '') {
                    autoResizeTextarea(newContentItemInput);
                } else {
                    // Nếu người dùng xóa hết, reset về chiều cao mặc định (rows=6)
                    newContentItemInput.style.height = 'auto'; 
                }
            });
            
            // Cho phép thêm slide bằng phím Enter trong ô notes nếu nội dung content rỗng
            blockNotesInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter' && currentBlockContent.length === 0 && currentBlockImageBase64 === null) {
                    e.preventDefault();
                    window.addNewBlock();
                }
            });
        };
    </script>
</head>
<body class="p-4 md:p-8 min-h-screen">

    <div class="max-w-4xl mx-auto">
        <header class="text-center mb-6">
            <h1 class="text-4xl font-extrabold text-gray-800">Ứng Dụng Tạo Slide Bài Giảng</h1>
            <p id="header-description" class="text-md text-indigo-500 font-semibold mt-3 mb-2">
                Cấu trúc: { Trang: 1, Template: "1", Tiêu đề: "...", Detail: "...", **Notes**: "...", ReferenceImageBase64: "...", Slides: [...] }
            </p>
            <!-- Hiển thị ID Người dùng giả định (Local) -->
            <p id="user-id-display" class="text-sm text-gray-500 mt-1"></p>
        </header>

        <!-- Hộp thông báo (thay thế alert) -->
        <div id="message-box" class="opacity-0 hidden" role="alert">
            <span id="message-text"></span>
        </div>

        <!-- Nút Tạo Bộ Slide Mới và Nút Tải xuống Toàn bộ -->
        <div class="mb-8 flex space-x-3 justify-end md:justify-start">
            <button id="add-task-btn" 
                    class="flex items-center px-4 py-2 bg-indigo-600 text-white font-semibold rounded-xl shadow-lg hover:bg-indigo-700 transition duration-200 transform hover:scale-[1.02]">
                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>
                Tạo một Bộ Slide mới
            </button>
            
            <!-- Nút Tải xuống Toàn bộ JSON -->
            <button id="download-all-btn"
                    title="Tải xuống TOÀN BỘ dữ liệu (Array JSON)"
                    class="flex items-center px-4 py-2 bg-gray-500 text-white font-semibold rounded-xl shadow-lg hover:bg-gray-600 transition duration-200 transform hover:scale-[1.02]">
                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
                </svg>
                Tải Toàn Bộ
            </button>
            
            <!-- Nút Nhập Toàn Bộ JSON (MỚI) -->
            <button id="import-all-btn"
                    title="Nhập (Upload) TOÀN BỘ dữ liệu (Array JSON) để THÊM MỚI"
                    class="flex items-center px-4 py-2 bg-purple-600 text-white font-semibold rounded-xl shadow-lg hover:bg-purple-700 transition duration-200 transform hover:scale-[1.02]">
                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0l-4 4m4-4v12"></path>
                </svg>
                Nhập Toàn Bộ
            </button>
        </div>

        <!-- Danh Sách Bộ Slide -->
        <div id="tasks-list" class="space-y-4">
            <p class="text-center text-gray-500 py-6">Đang tải dữ liệu...</p>
        </div>
    </div>

    <!-- Modal (Popup) Tạo/Sửa Bộ Slide -->
    <div id="task-modal" class="modal hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-0 md:p-4 z-50">
        <div class="modal-content bg-white p-4 md:p-8 rounded-none md:rounded-2xl shadow-2xl w-full h-full md:h-[98vh] md:max-w-7xl flex flex-col">
            
            <!-- Tiêu đề Modal (Cố định - flex-shrink-0) -->
            <h2 id="modal-title" class="text-2xl font-bold mb-4 text-gray-800 flex-shrink-0">Tạo một Bộ Slide mới</h2>
            
            <!-- Nội dung Form (Cuộn được - flex-grow & overflow-y-auto) -->
            <div class="flex-grow overflow-y-auto pr-2">

                <!-- 1a. SỐ TRANG (PAGE NUMBER) & 1b. MẪU (TEMPLATE) -->
                <div class="flex space-x-4 mb-4">
                    <div class="flex-1">
                        <label for="task-page-input" class="block text-sm font-medium text-gray-700 mb-2">1a. Số Trang (Page Number):</label>
                        <input type="number" id="task-page-input" 
                            class="w-full p-3 border border-gray-300 rounded-xl focus:ring-indigo-500 focus:border-indigo-500" 
                            placeholder="Ví dụ: 1..." min="1" value="1">
                    </div>
                    <div class="flex-1">
                        <!-- ĐÃ CẬP NHẬT: for="task-type-input" -> for="task-template-input" & label text -->
                        <label for="task-template-input" class="block text-sm font-medium text-gray-700 mb-2">1b. Mẫu (Template):</label>
                        <input type="text" id="task-template-input" 
                            class="w-full p-3 border border-gray-300 rounded-xl focus:ring-indigo-500 focus:border-indigo-500" 
                            placeholder="Ví dụ: 1, 2, 'final'..." value="1">
                    </div>
                </div>

                <!-- 1c. TIÊU ĐỀ BỘ SLIDE (TITLE) -->
                <label for="task-title-input" class="block text-sm font-medium text-gray-700 mb-2">1c. Tiêu đề Bộ Slide/Bài Giảng:</label>
                <input type="text" id="task-title-input" 
                    class="w-full p-3 border border-gray-300 rounded-xl focus:ring-indigo-500 focus:border-indigo-500 mb-4" 
                    placeholder="Ví dụ: Giới thiệu về AI (title)...">
                    
                <!-- 1d. GIẢI THÍCH CHI TIẾT (DETAIL) - TEXTAREA -->
                <label for="task-detail-input" class="block text-sm font-medium text-gray-700 mb-2">1d. Giải Thích Chi Tiết (Detail):</label>
                <textarea id="task-detail-input" rows="3"
                    class="w-full p-3 border border-gray-300 rounded-xl focus:ring-indigo-500 focus:border-indigo-500 mb-4 resize-y" 
                    placeholder="Giải thích ngắn gọn về mục tiêu hoặc nội dung bao quát của bài giảng (detail)..."></textarea>
                    
                <!-- 1f. GHI CHÚ (NOTES) - TEXTAREA (THÊM MỚI) -->
                <label for="task-notes-input" class="block text-sm font-medium text-gray-700 mb-2">1f. Ghi Chú (Presenter Notes):</label>
                <textarea id="task-notes-input" rows="3"
                    class="w-full p-3 border border-gray-300 rounded-xl focus:ring-indigo-500 focus:border-indigo-500 mb-4 resize-y" 
                    placeholder="Ghi chú chi tiết dành cho người trình bày (notes)..."></textarea>


                <!-- 1e. NGUỒN THAM KHẢO (SINGLE IMAGE) - IMAGE UPLOAD (CHUNG CHO BỘ SLIDE) -->
                <label for="image-upload-input" class="inline-flex items-center px-4 py-2 bg-purple-600 text-white font-semibold text-sm rounded-xl shadow-md hover:bg-purple-700 transition duration-150 cursor-pointer">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path></svg>
                    Tải ẢNH THAM KHẢO CHUNG (1e. Ảnh Tham Khảo Chung)
                </label>
                <input type="file" id="image-upload-input" accept="image/*" class="hidden">
                
                <!-- Container hiển thị ảnh đã tải lên (CHUNG) -->
                <div id="reference-images-container" class="space-y-2 mt-4 p-3 border border-dashed border-gray-300 rounded-xl bg-gray-50 mb-6 max-h-48 overflow-y-auto">
                    <p class="text-center text-gray-400 text-sm py-2">Chưa có ảnh tham khảo chung nào được thêm.</p>
                </div>


                <div class="space-y-4">
                    <!-- ĐÃ ĐỔI TỪ "Quản lý Slide" SANG "Nội dung trong Slide" -->
                    <label class="block text-lg font-bold text-gray-700 border-b pb-2">2. Nội dung trong Slide</label>
                    
                    <!-- Hiển thị danh sách các Slides đã thêm -->
                    <div id="blocks-list-container" class="space-y-3 max-h-48 overflow-y-auto p-2 border border-dashed border-gray-300 rounded-xl bg-gray-50 mb-4">
                        <p class="text-center text-gray-400 text-sm py-2">Chưa có slide nào được thêm.</p>
                    </div>

                    <!-- FORM NHẬP/CHỈNH SỬA SLIDE HIỆN TẠI (Tạo/Sửa Slide) -->
                    <div class="p-4 border border-indigo-300 rounded-xl bg-indigo-50 space-y-3">
                        <p class="font-semibold text-indigo-700">Tạo/Sửa Slide</p>
                        
                        <!-- THỨ TỰ (ORDER) & TIÊU ĐỀ SLIDE -->
                        <div class="flex space-x-4">
                            <div class="w-1/4">
                                <label for="block-order-input" class="block text-xs font-medium text-gray-700">Thứ tự (Order):</label>
                                <input type="number" id="block-order-input" 
                                    class="w-full p-2 border border-gray-300 rounded-xl focus:ring-indigo-500 focus:border-indigo-500" 
                                    placeholder="1" min="1" value="1">
                            </div>
                            <div class="flex-grow">
                                <label for="block-notes-input" class="block text-xs font-medium text-gray-700">Tiêu đề Slide:</label>
                                <input type="text" id="block-notes-input" 
                                    class="w-full p-2 border border-gray-300 rounded-xl focus:ring-indigo-500 focus:border-indigo-500" 
                                    placeholder="Ví dụ: Định nghĩa và Lịch sử (notes)...">
                            </div>
                        </div>

                        <!-- UPLOAD ẢNH RIÊNG CHO SLIDE -->
                        <label for="block-image-upload-input" class="inline-flex items-center px-4 py-2 bg-pink-600 text-white font-semibold text-sm rounded-xl shadow-md hover:bg-pink-700 transition duration-150 cursor-pointer">
                            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.218A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.218A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                            Tải Ảnh Slide (1 ảnh riêng cho slide)
                        </label>
                        <input type="file" id="block-image-upload-input" accept="image/*" class="hidden">

                        <!-- Container hiển thị ảnh Slide đã tải lên -->
                        <div id="block-image-preview-container" class="space-y-2 p-1 border border-dashed border-gray-300 rounded-xl bg-white max-h-32 overflow-y-auto">
                            <p class="text-center text-gray-400 text-sm py-2">Chưa có ảnh nào cho Slide này.</p>
                        </div>
                        
                        <!-- NỘI DUNG GẠCH ĐẦU DÒNG -->
                        <label class="block text-xs font-medium text-gray-700 pt-2">Nội dung/Gạch đầu dòng (Mỗi dòng là 1 mục):</label>
                        <div id="new-content-input-group" class="flex space-x-2 items-start">
                            <!-- ĐÃ CẬP NHẬT: rows="3" thành rows="6" -->
                            <textarea id="new-content-item-input" 
                                class="flex-grow p-2 border border-gray-300 rounded-xl focus:ring-indigo-500 focus:border-indigo-500 auto-resize" 
                                rows="6" placeholder="Nhập từng dòng (Mỗi dòng sẽ là 1 gạch đầu dòng riêng khi nhấn + Dòng)..."></textarea>
                            
                            <button id="add-content-item-btn" type="button" 
                                    class="px-3 py-1 bg-green-500 text-white font-semibold rounded-xl hover:bg-green-600 transition duration-150 text-sm flex-shrink-0 mt-1">
                                + Dòng
                            </button>
                        </div>
                        
                        <!-- HIỂN THỊ DANH SÁCH DÒNG NỘI DUNG CÓ ORDER ID VÀ NÚT CHỈNH SỬA THỨ TỰ -->
                        <div id="current-block-content-list" class="space-y-1 max-h-40 overflow-y-auto p-2 border border-gray-200 rounded-xl bg-white">
                            <p class="text-center text-gray-400 text-sm py-2">Chưa có dòng nội dung nào được thêm.</p>
                        </div>

                        <!-- Cập nhật tên nút: Thêm Slide Mới -> Thêm mới nội dung mới -->
                        <button id="add-new-block-btn" type="button"
                                class="w-full px-4 py-2 bg-indigo-600 text-white font-semibold rounded-xl hover:bg-indigo-700 transition duration-150">
                            Thêm mới nội dung mới
                        </button>
                        <!-- Cập nhật tên nút: Hủy Chỉnh Sửa Slide -> Hủy Chỉnh Sửa Nội Dung -->
                        <button type="button" onclick="window.resetBlockForm()"
                                class="w-full px-4 py-2 bg-gray-300 text-gray-700 font-semibold rounded-xl hover:bg-gray-400 transition duration-150">
                            Hủy Chỉnh Sửa Nội Dung
                        </button>
                    </div>
                </div>
            </div> <!-- Kết thúc vùng cuộn (flex-grow) -->
            
            <!-- Nút Action Footer (Cố định - flex-shrink-0) -->
            <div class="flex justify-end space-x-3 mt-6 border-t pt-4 flex-shrink-0">
                <button id="close-modal-btn" 
                        class="px-4 py-2 bg-gray-300 text-gray-700 font-semibold rounded-xl hover:bg-gray-400 transition duration-150">
                    Hủy
                </button>
                <!-- Cập nhật tên nút: Lưu Slide -->
                <button id="save-task-btn" 
                        class="px-4 py-2 bg-indigo-600 text-white font-semibold rounded-xl hover:bg-indigo-700 transition duration-150">
                    Lưu Slide
                </button>
            </div>
        </div>
    </div>

    <!-- Modal (Popup) Xem Chi Tiết Bộ Slide -->
    <div id="view-modal" class="modal hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
        <div class="modal-content bg-white p-0 rounded-2xl shadow-2xl w-full max-w-xl">
            
            <!-- Nội dung chi tiết được bao quanh bởi một padding riêng -->
            <div id="view-task-details" class="space-y-4 max-h-[70vh] overflow-y-auto">
                <p class="text-center text-gray-500 py-4">Đang tải chi tiết...</p>
            </div>

            <div class="flex justify-end mt-0 p-4 border-t border-gray-200">
                <button id="close-view-modal-btn"
                        class="px-4 py-2 bg-indigo-600 text-white font-semibold rounded-xl hover:bg-indigo-700 transition duration-150">
                    Đóng
                </button>
            </div>
        </div>
    </div>

</body>
</html>
